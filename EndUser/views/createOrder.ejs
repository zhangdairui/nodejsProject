<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Cart</title>
    <!-- ======================JS引入================================== -->
    <!-- jQuery必在bootstrap.min.js 之前引入 -->
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <!-- bootstrap.bundle.min.js 用于弹窗、提示、下拉菜单，包含了 popper.min.js -->
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <!-- Bootstrap4 核心 JavaScript 文件 -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <!-- ======================CSS引入================================== -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <!-- Header Part Start -->
    <header class='header-area'>
        <!-- header-top -->
        <div class='header-top'>
            <div class='container'>
                <div class='row'>
                    <div class='col-lg-12'>
                        <div class='header-top-item d-block d-md-flex justify-content-between align-items-center'>
                            <div class='header-contact'>
                                <ul>
                                    <li><a href='tel:+125123658'>Call us: CS631-631-631</a></li>
                                    <li><a href='mailto:XXX'>Email: dz9@njit.edu</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- header-main-->
        <div class='main-header'>
            <div class='container'>
                <div class='row align-items-center'>
                    <div class='col-lg-2 col-md-3'>
                        <div class='logo'>
                            <a href='/'><img src='/images/NFClogo.png' height=90px alt='logo'></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- header-menu(navi&cart&account) -->
        <div class='header-menu'>
            <div class='container'>
                <div class='row'>
                    <div class='col-lg-12'>
                        <div class='navigation'>
                            <nav class='navbar navbar-expand-lg navbar-light '>
                                <button class='navbar-toggler' type='button' data-toggle='collapse' data-target='#navbarSupportedContent' aria-controls='navbarSupportedContent' aria-expanded='false' aria-label='Toggle navigation'>
                                    <span class='toggler-icon'></span>
                                    <span class='toggler-icon'></span>
                                    <span class='toggler-icon'></span>
                                </button> <!-- navbar toggler -->
                                <div class='collapse navbar-collapse sub-menu-bar' id='navbarSupportedContent'>
                                    <ul class='navbar-nav mr-auto'>
                                        <li class='nav-item active'><a class='nav-link' href='/'>Home</a></li>
                                        <li class='nav-item'>
                                            <div class="dropdown" style="margin-left: 20px;">
                                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Account</a>
                                                <div class="dropdown-menu" style="background-color: #215378;">
                                                    <ul style="color: white;font-size: 6px;">User:
                                                        <span id="userID"><%=userID%></span>
                                                    </ul>
                                                    <a class="dropdown-item" href="/account">Profile & Order</a>
                                                    <a class="dropdown-item" href="/logout">Log Out</a>
                                                </div>
                                            </div>
                                        </li>
                                        <li class='nav-item'>
                                            <a class='nav-link' href='/about'>About</a>
                                        </li>
                                    </ul>
                                </div> <!-- navbar collapse -->
                                <div class='navbar-btn d-flex'>
                                    <ul>
                                        <li><a href='/cart'><i class='fa fa-shopping-cart'></i>Cart</a></li>
                                    </ul>
                                </div>
                            </nav>
                        </div> <!-- navigation -->
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Header Part End-->
    <section class="cart-content-block container inputAddress">
        <div class="row">
            <div class="col-12">
                <p>This is the page for confirming your order. Or you can <a href="/cart" style="text-decoration: underline;color: #FF8E47;">Click here</a> to back to your cart.</p>
                <br><br>
                <h2 style="color: #215378;">Input Your Shipping Address <i class="fa fa-truck" aria-hidden="true"></i></h2>
                <br><br>
                <div class="form-group">
                    <label for="addr">Address:</label>
                    <input type="text" class="form-control" id="ShippingAddr" placeholder="Enter Address">
                </div>
            </div>
        </div>
    </section>
    <section class="cart-content-block container">
        <div class="row">
            <div class="col-12">
                <h2 style="color: #215378;">Confirm Your Order <i class="fa fa-shopping-cart" aria-hidden="true"></i></h2>
                <br><br>
                <div class="table-responsive">
                    <table class="table cart-data-table" id="cartProductInfo">
                        <thead>
                            <tr>
                                <th class="id text-center">Product ID</th>
                                <th class="Product text-center">Products</th>
                                <th class="price text-center">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% CART_PRODUCTS.forEach((item) => { %>
                            <!-- 这里的USER接住了app.js传来的被定义成USER的results，item是新定义的 -->
                            <tr>
                                <td class="id-column text-center"><%= item.id %></td>
                                <td class="name-column text-center"><%= item.productName %></td>
                                <td class="price-column text-center"><%= item.price%></td>
                            </tr>

                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4 col-xlg-4 col-md-4">
                <div class="table-wrap">
                    <h2 style="color: #215378;">Total</h2>
                    <p>You will pay with PAY-PAL</p>
                    <ul class="list-unstyled cart-total" style="color:#215378; ">
                        <li>
                            <strong class="subTotal-title pull-left">Sub-Total:</strong>
                            <strong class="subTotal-price pull-right">$<span class="cart-subtotal">0
                                </span></strong>
                        </li>
                        <li>
                            <strong class="Total-title pull-left">Total:</strong>
                            <strong class="Total-price pull-right">$<span class="cart-all-total">0</span></strong>
                            <span class="shipping-fee">Shipping:$<span class="shipping-fee-value">15</span></span>
                        </li>
                    </ul>
                    <a href="#" class="btn-primary text-center text-uppercase" id="submitOrder">Pay and Submit Order</a>
                </div>
            </div>
    </section>
</body>

</html>
<script>
//删除功能后端实现，购物车内的计算由前端实现
//------------------------下面开始前端计算------------------------//

var shipping = 15.00;
var fadeTime = 300;

$(document).ready(function() { //打开页面之后立刻就执行的函数

    recalculateCart(); //这个函数在下面定义的，用来统计total页面


})


// Recalculate cart 
function recalculateCart() { //计算用函数
    var subtotal = 0;

    /* Sum up row totals */
    $('.price-column').each(function() {
        subtotal += parseFloat($(this).text());
    });

    /* Calculate totals */
    var total = subtotal + shipping;

    /* Update totals display */
    $('.price-column').fadeOut(fadeTime, function() {
        $('.cart-subtotal').html(subtotal.toFixed(2));

        $('.cart-all-total').html(total.toFixed(2));

        $('.price-column').fadeIn();

    });
}





//------------------------提交订单按钮发送ajax给后端------------------------//
$('#submitOrder').click(function() {


    var user = $('#userID').text(); //获取本页面的用户邮箱
    
    var product_id = new Array();
    product_id.push("abc"); //这里的abc参数必备。否则当购物车里只有一件商品的时候，后台不知道是数组，会当成string去拆分。
     //遍历名为idcolumn的class获取数组，存为product_id一维数组
    $(".id-column").each(function() {
        var a = $(this).html();
        product_id.push(a);
            });
    console.log(product_id);
    var shippingAddr = $('#ShippingAddr').val(); //获取填写的address
    var allTotal = $('.cart-all-total').text();
    // var createOrder = { userMail: user, shippingAddr: shippingAddr, total: allTotal};
   
    if ($('#ShippingAddr').val() !== ""){
         $.ajax({ 

            type: 'post',
            url: '/create', //后端通过这个url来识别这次ajax
            dataType: 'json',
            data: { userMail: user, shippingAddr: shippingAddr, total: allTotal, order_inventory: product_id},
            traditional:true, //用户向后端传数组 
            success: function(data) {
                if (data.code > 0) { //如果后端传来的datacode大于0,说明添加订单成功
                    alert("Submit Succeed");
                   $(location).attr("href","/");

                } 
                else{
                    alert("Submit faided!!!!");
                } 
            },
            error: function(error) {
                console.log(error)
            }
        })

    }else{
        alert("Enter Your Address Please!!") //地址不能为空值
    }
});
</script>